{"version":3,"sources":["../src/datasource.js"],"names":["_","axios","pako","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","basicAuth","length","console","log","jsonData","appiot","appiotaccesstoken","appiotdevicenetwork","resourceList","getAllResourceUrlFromDevice","then","result","catch","err","rweflag","deviceidentifier","split","objecttypeid","Promise","resolve","reject","apiURI","get","apiHeaders","data","Rows","Id","promiseArray","SmartObjects","forEach","obj","TypeId","promise","push","all","spread","args","i","resource","AccessType","error","message","lat","lon","precision","Geohash","base32","decode","geohash","bounds","latMin","sw","lonMin","latMax","ne","lonMax","toFixed","Math","floor","LN10","Number","p","hash","GeohashEncode","posn","isNaN","Error","idx","bit","evenBit","lonMid","latMid","charAt","options","Base64","characters","_keyStr","encode","string","a","charCodeAt","b","c","b1","b2","b3","b4","indexOf","String","fromCharCode","decodeBase64","s","e","x","l","r","w","L","A","decodeArrayBuffer","input","bytes","ab","ArrayBuffer","removePaddingChars","lkey","substring","decode2","arrayBuffer","parseInt","uarray","chr1","chr2","chr3","enc1","enc2","enc3","enc4","j","Uint8Array","replace","query","buildQueryParameters","targets","filter","t","hide","caller","req","when","getQueryForAppIoT","target","targetresource","find","Name","from","Date","range","getTime","to","currenttime","tsResultArray","latestMeasurementTime","latestMeasurementValue","tsResult","config","targettype","columns","col1","text","sort","desc","col2","col3","col4","col5","rows","v","value","part","sv","row","UnixTimestamp","geoh","toISOString","AggregationType","col","m","bv","datapoints","arr","val","timestamp","unzipdata","decodeddata","inflate","varr","firstts","ts","LatestMeasurement","voidLatestMeasurement","status","title","calleroption","eventcategoryname","annotation","event","time","CreatedDateTime","EventCategoryName","toUpperCase","ann","enabled","datasource","showLine","RuleName","ResetDateTime","tags","list","mapToTextValue","map","d","isObject","datasourceRequest","scopedVars","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport * as axios from \"./node_modules/axios/dist/axios\";\nimport * as pako from \"./node_modules/pako/dist/pako\";\n\n\n\n\nexport class GenericDatasource {\n\n\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n   /* this.geolocationv = []\n    for (var i = 0; i < 50; i++) {\n      var a = {}\n      a.UnixTimestamp = (new Date().getTime()) - Math.random() * 600000;\n      var b = '22.288702,114.211625,30'\n      var bp = b.split(',')\n      bp[0] = Number(bp[0]) - Math.random() * 0.002\n      bp[1] = Number(bp[1]) - Math.random() * 0.003\n      bp[2] = Math.floor(Number(bp[2]) + Math.random() * 20)\n      a.sv = bp[0] + ',' + bp[1] + ',' + bp[2]\n      this.geolocationv.push(a)\n    }*/\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.headers = { 'Content-Type': 'application/json' };\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n    console.log(instanceSettings.jsonData)\n    this.appiot = {\n      //'apiURI': 'https://iotabusinesslab-api.sensbysigma.com/api/v3',\n      'apiURI': instanceSettings.url,\n      'apiHeaders': {\n        'Authorization': instanceSettings.jsonData.appiotaccesstoken,\n        'X-DeviceNetwork': instanceSettings.jsonData.appiotdevicenetwork,\n        //'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkbklkIjoiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwIiwicGVybWlzc2lvbnMiOm51bGwsImlzcyI6ImFwcGlvdHdlYmFwaSIsImF1ZCI6ImFwcGlvdHdlYmFwaSIsImV4cCI6MTUxNTkzMzM1MywibmJmIjoxNTA4NTA4OTEwLCJpYXQiOjE1MDg1MDg5MTAsIm5hbWUiOiJCTEFCSEsiLCJ0b2tlblR5cGUiOiJhY2Nlc3NUb2tlbiIsInVzZXJJZCI6IjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCJ9.E0xhLJjh+tEO2w7Tvtx+sco6h8WlWN2nVSGHpTKkn0Q=',\n        //'X-DeviceNetwork': '613b7124-e2db-4e76-9feb-102a869bd497',\n        'Content-Type': 'application/json',\n      },\n    }\n\n    this.resourceList = null;\n    this.getAllResourceUrlFromDevice(1)\n      .then((result) => {\n        this.resourceList = result;\n        /*var resource = this.resourceList.find(resource => {\n          return resource.Name == \"BleSensor\"\n        })*/\n        console.log(this.resourceList.length)\n      })\n      .catch((err) => {\n        console.log(err)\n      })\n\n  }\n\n\n  getAllResourceUrlFromDevice(rweflag) { // objecttypeid is the lwm2m object id in the resourceurl e.g. 3303      \n    const deviceidentifier = this.name.split(\"/\")[0]\n    const objecttypeid = this.name.split(\"/\")[1]\n    const appiot = this.appiot\n    return new Promise(function (resolve, reject) {\n      let url = `${appiot.apiURI}/devices?filter[0].Key=deviceidentifier&filter[0].Value=${deviceidentifier}`\n      axios.get(url, { 'headers': appiot.apiHeaders })\n        .then((result) => {\n          if (result.data.Rows.length > 0) {\n            let resourceList = [];\n            let url = `${appiot.apiURI}/devices/${result.data.Rows[0].Id}`;\n            axios.get(url, { 'headers': appiot.apiHeaders })\n              .then((result) => {\n                let promiseArray = [];\n                result.data.SmartObjects.forEach((obj) => {\n                  if (obj.TypeId == objecttypeid) {\n                    url = `${appiot.apiURI}/resources?filter[0].Key=smartobjectid&filter[0].Value=${obj.Id}`;\n                    let promise = axios.get(url, { 'headers': appiot.apiHeaders })\n                    promiseArray.push(promise)\n                  }\n                })\n                if (promiseArray.length == 0) {\n                  reject(`Cannot found matching object type id?: ${objecttypeid}`);\n                }\n                // perform concurrent get calls for all smart objects                       \n                axios.all(promiseArray)\n                  .then(axios.spread((...args) => {\n                    for (let i = 0; i < args.length; i++) {\n                      args[i].data.Rows.forEach((resource) => { // resource obj\n                        if ((resource.AccessType & rweflag) > 0) { // required bitand with flag\n                          resourceList.push(resource)\n                        }\n                      })\n                    }\n                    if (resourceList.length == 0) {\n                      reject(`Cannot found matching AccessType?: ${rweflag}`);\n                    }\n                    resolve(resourceList)\n                  }))\n                  .catch((error) => {\n                    console.log(error);\n                    reject(`error getting /resources?: ${error.message}`);\n                  })\n              })\n              .catch((error) => {\n                console.log(error);\n                reject(`error getting /devices/id: ${error.message}`);\n              })\n          } else {\n            reject(`deviceidentifier not found: ${error.message}`);\n          }\n        })\n        .catch((error) => {\n          console.log(error);\n          reject(`error getting deviceidentifier: ${error.message}`);\n        })\n    })\n  }\n\n\n\n  GeohashEncode(lat, lon, precision) {\n    var Geohash = {};\n    /* (Geohash-specific) Base32 map */\n    Geohash.base32 = '0123456789bcdefghjkmnpqrstuvwxyz';\n    Geohash.decode = function (geohash) {\n\n      var bounds = Geohash.bounds(geohash); // <-- the hard work\n      // now just determine the centre of the cell...\n\n      var latMin = bounds.sw.lat, lonMin = bounds.sw.lon;\n      var latMax = bounds.ne.lat, lonMax = bounds.ne.lon;\n\n      // cell centre\n      var lat = (latMin + latMax) / 2;\n      var lon = (lonMin + lonMax) / 2;\n\n      // round to close to centre without excessive precision: ⌊2-log10(Δ°)⌋ decimal places\n      lat = lat.toFixed(Math.floor(2 - Math.log(latMax - latMin) / Math.LN10));\n      lon = lon.toFixed(Math.floor(2 - Math.log(lonMax - lonMin) / Math.LN10));\n\n      return { lat: Number(lat), lon: Number(lon) };\n    };\n\n    // infer precision?\n    if (typeof precision == 'undefined') {\n      // refine geohash until it matches precision of supplied lat/lon\n      for (var p = 1; p <= 12; p++) {\n        var hash = this.GeohashEncode(lat, lon, p);\n        var posn = Geohash.decode(hash);\n        if (posn.lat == lat && posn.lon == lon) return hash;\n      }\n      precision = 12; // set to maximum\n    }\n\n    lat = Number(lat);\n    lon = Number(lon);\n    precision = Number(precision);\n\n    if (isNaN(lat) || isNaN(lon) || isNaN(precision)) throw new Error('Invalid geohash');\n\n    var idx = 0; // index into base32 map\n    var bit = 0; // each char holds 5 bits\n    var evenBit = true;\n    var geohash = '';\n\n    var latMin = -90, latMax = 90;\n    var lonMin = -180, lonMax = 180;\n\n    while (geohash.length < precision) {\n      if (evenBit) {\n        // bisect E-W longitude\n        var lonMid = (lonMin + lonMax) / 2;\n        if (lon >= lonMid) {\n          idx = idx * 2 + 1;\n          lonMin = lonMid;\n        } else {\n          idx = idx * 2;\n          lonMax = lonMid;\n        }\n      } else {\n        // bisect N-S latitude\n        var latMid = (latMin + latMax) / 2;\n        if (lat >= latMid) {\n          idx = idx * 2 + 1;\n          latMin = latMid;\n        } else {\n          idx = idx * 2;\n          latMax = latMid;\n        }\n      }\n      evenBit = !evenBit;\n\n      if (++bit == 5) {\n        // 5 bits gives us a character: append it and start over\n        geohash += Geohash.base32.charAt(idx);\n        bit = 0;\n        idx = 0;\n      }\n    }\n\n    return geohash;\n  };\n\n  query(options) {\n    //var gzip = require('gzip-js')\n    //var zlib = require('zlib');\n    var Base64 = {\n      characters: \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\",\n      _keyStr : \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\",\n      encode: function (string) {\n        var characters = Base64.characters;\n        var result = '';\n\n        var i = 0;\n        do {\n          var a = string.charCodeAt(i++);\n          var b = string.charCodeAt(i++);\n          var c = string.charCodeAt(i++);\n\n          a = a ? a : 0;\n          b = b ? b : 0;\n          c = c ? c : 0;\n\n          var b1 = (a >> 2) & 0x3F;\n          var b2 = ((a & 0x3) << 4) | ((b >> 4) & 0xF);\n          var b3 = ((b & 0xF) << 2) | ((c >> 6) & 0x3);\n          var b4 = c & 0x3F;\n\n          if (!b) {\n            b3 = b4 = 64;\n          } else if (!c) {\n            b4 = 64;\n          }\n\n          result += Base64.characters.charAt(b1) + Base64.characters.charAt(b2) + Base64.characters.charAt(b3) + Base64.characters.charAt(b4);\n\n        } while (i < string.length);\n\n        return result;\n      },\n\n      decode: function (string) {\n        var characters = Base64.characters;\n        var result = '';\n\n        var i = 0;\n        do {\n          var b1 = Base64.characters.indexOf(string.charAt(i++));\n          var b2 = Base64.characters.indexOf(string.charAt(i++));\n          var b3 = Base64.characters.indexOf(string.charAt(i++));\n          var b4 = Base64.characters.indexOf(string.charAt(i++));\n\n          var a = ((b1 & 0x3F) << 2) | ((b2 >> 4) & 0x3);\n          var b = ((b2 & 0xF) << 4) | ((b3 >> 2) & 0xF);\n          var c = ((b3 & 0x3) << 6) | (b4 & 0x3F);\n\n          result += String.fromCharCode(a) + (b ? String.fromCharCode(b) : '') + (c ? String.fromCharCode(c) : '');\n\n        } while (i < string.length);\n\n        return result;\n      },\n\n      decodeBase64: function(s) {\n        var e={},i,b=0,c,x,l=0,a,r='',w=String.fromCharCode,L=s.length;\n        var A=\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n        for(i=0;i<64;i++){e[A.charAt(i)]=i;}\n        for(x=0;x<L;x++){\n            c=e[s.charAt(x)];b=(b<<6)+c;l+=6;\n            while(l>=8){((a=(b>>>(l-=8))&0xff)||(x<(L-2)))&&(r+=w(a));}\n        }\n        return r;\n      },\n      /* will return a  Uint8Array type */\n      decodeArrayBuffer: function (input) {\n        var bytes = (input.length / 4) * 3;\n        var ab = new ArrayBuffer(bytes);\n        this.decode(input, ab);\n\n        return ab;\n      },\n\n      removePaddingChars: function (input) {\n        var lkey = this._keyStr.indexOf(input.charAt(input.length - 1));\n        if (lkey == 64) {\n          return input.substring(0, input.length - 1);\n        }\n        return input;\n      },\n\n      decode2: function (input, arrayBuffer) {\n        //get last chars to see if are valid\n        input = this.removePaddingChars(input);\n        input = this.removePaddingChars(input);\n\n        var bytes = parseInt((input.length / 4) * 3, 10);\n\n        var uarray;\n        var chr1, chr2, chr3;\n        var enc1, enc2, enc3, enc4;\n        var i = 0;\n        var j = 0;\n\n        if (arrayBuffer)\n          uarray = new Uint8Array(arrayBuffer);\n        else\n          uarray = new Uint8Array(bytes);\n\n        input = input.replace(/[^A-Za-z0-9\\+\\/\\=]/g, \"\");\n\n        for (i = 0; i < bytes; i += 3) {\n          //get the 3 octects in 4 ascii chars\n          enc1 = this._keyStr.indexOf(input.charAt(j++));\n          enc2 = this._keyStr.indexOf(input.charAt(j++));\n          enc3 = this._keyStr.indexOf(input.charAt(j++));\n          enc4 = this._keyStr.indexOf(input.charAt(j++));\n\n          chr1 = (enc1 << 2) | (enc2 >> 4);\n          chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);\n          chr3 = ((enc3 & 3) << 6) | enc4;\n\n          uarray[i] = chr1;\n          if (enc3 != 64) uarray[i + 1] = chr2;\n          if (enc4 != 64) uarray[i + 2] = chr3;\n        }\n\n        return uarray;\n      }\n    };\n\n    var query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n    const caller = this\n    const req = query\n\n    if (query.targets.length <= 0) {\n      return this.q.when({ data: [] });\n    }\n    var getQueryForAppIoT = function(resolve, reject) { \n      let promiseArray = [];\n      req.targets.forEach((target) => {\n        var resource = null;\n        if (target.target.indexOf('TimeWeightedAverage') >= 0 || target.target.indexOf('Variance') >= 0) {\n          var targetresource = target.target.split(',')[0]\n          resource = caller.resourceList.find(resource => {\n            return resource.Name == targetresource\n          })\n        }\n        else {\n          resource = caller.resourceList.find(resource => {\n            return resource.Name == target.target\n          })\n        }\n        var from = new Date(req.range.from).getTime();\n        var to = new Date(req.range.to).getTime();\n        var url = null;\n        if (target.target.indexOf('TimeWeightedAverage') >= 0) {\n          url = `${caller.appiot.apiURI}/measurements/${resource.Id}/aggregations?measurementQuery.resolution=300000&measurementQuery.timespanStart=${from}&measurementQuery.timespanEnd=${to}&measurementQuery.aggregationType=TimeWeightedAverage`;\n        }\n        else if (target.target.indexOf('Variance') >= 0) {\n          url = `${caller.appiot.apiURI}/measurements/${resource.Id}/aggregations?measurementQuery.resolution=300000&measurementQuery.timespanStart=${from}&measurementQuery.timespanEnd=${to}&measurementQuery.aggregationType=Variance`;\n        }\n        /*else if (target.target.indexOf('HealthSensor Accuracy') >= 0) {\n          resource = caller.resourceList.find(resource => {\n            return resource.Name == \"acHealthSensor\"\n          })\n          url = `${caller.appiot.apiURI}/measurements/${resource.Id}/since/${from}/to/${to}`;\n          let promise = axios.get(url, { 'headers': caller.appiot.apiHeaders, 'target': 'HealthSensorAcc', 'targettype': target.type }).catch((err) => { console.log(err) })\n          promiseArray.push(promise)  \n          resource = caller.resourceList.find(resource => {\n            return resource.Name == \"HealthSensor\"\n          })\n          url = `${caller.appiot.apiURI}/measurements/${resource.Id}/since/${from}/to/${to}`;\n          promise = axios.get(url, { 'headers': caller.appiot.apiHeaders, 'target': 'HealthSensorPre', 'targettype': target.type }).catch((err) => { console.log(err) })\n          promiseArray.push(promise) \n          return //continue \n        }*/\n        else {\n          var currenttime = new Date().getTime();\n          if ((currenttime-to) <= 60000 ) { // if time is within \"latest\", we may need to purposely inject latest measurement to the result\n            url = `${caller.appiot.apiURI}/resources/${resource.Id}`;\n            let promise = axios.get(url, { 'headers': caller.appiot.apiHeaders, 'target': 'latestmeasurement', 'targettype': target.type }).catch((err) => { console.log(err) })\n            promiseArray.push(promise)\n          }\n          url = `${caller.appiot.apiURI}/measurements/${resource.Id}/since/${from}/to/${to}`;\n        }\n        let promise = axios.get(url, { 'headers': caller.appiot.apiHeaders, 'target': target.target, 'targettype': target.type }).catch((err) => { console.log(err) })\n        promiseArray.push(promise)\n    \n      })\n      var tsResultArray = [];\n      // perform concurrent get calls for all smart objects                       \n      //var healthSensorAcc = [];\n      //var healthSensorPre = [];\n      var latestMeasurementTime = null;\n      var latestMeasurementValue = null;\n      axios.all(promiseArray)\n        .then(axios.spread((...args) => {\n          for (let i = 0; i < args.length; i++) {\n            var tsResult = {}\n            if (args[i] == null) {\n              continue;\n            }\n  \n            if (args[i].config.targettype == 'table') {\n              if (args[i].config.target == 'GeoLocation') {\n                tsResult.columns = []\n                var col1 = {}\n                col1.text = 'Time'\n                col1.type = 'time'\n                col1.sort = true,\n                  col1.desc = true,\n                  tsResult.columns.push(col1)\n                var col2 = {}\n                col2.text = 'sv'\n                col2.type = 'string'\n                tsResult.columns.push(col2)\n                var col3 = {}\n                col3.text = 'metric'\n                col3.type = 'string'\n                tsResult.columns.push(col3)\n                var col4 = {}\n                col4.text = 'geohash'\n                col4.type = 'string'\n                tsResult.columns.push(col4)\n                var col5 = {}\n                col5.text = 'timestr'\n                col5.type = 'string'\n                tsResult.columns.push(col5)\n                tsResult.rows = []\n                tsResult.type = 'table'\n  \n                args[i].data.v.forEach((value) => { // resource obj\n  \n                  //caller.geolocationv.forEach((value) => { // resource obj\n                  var part = value.sv.split(\",\")\n                  if (part.length < 3) {\n  \n                  }\n                  else {\n                    var row = []\n                    row.push(value.UnixTimestamp)\n                    row.push(value.sv)\n                    row.push(part[2])\n                    var lat = Number(part[0]);// - Math.random() * 0.002\n                    var lon = Number(part[1]);// - Math.random() * 0.003\n                    var geoh = caller.GeohashEncode(lat, lon, 9)\n                    row.push(geoh)\n                    row.push(new Date(value.UnixTimestamp).toISOString())\n                    tsResult.rows.push(row)\n                  }\n                })\n              }\n              else {\n                if (args[i].data.AggregationType != null) {\n                  tsResult.columns = []\n                  var col1 = {}\n                  col1.text = 'Time'\n                  col1.type = 'time'\n                  col1.sort = true,\n                    col1.desc = true,\n                    tsResult.columns.push(col1)\n                  var col = {}\n                  col.text = 'm'\n                  col.type = 'number'\n                  tsResult.columns.push(col)\n                  tsResult.rows = []\n                  tsResult.type = 'table'\n                  args[i].data.v.forEach((value) => { // resource obj\n                    var row = []\n                    row.push(value.t)\n                    row.push(value.m)\n                    tsResult.rows.push(row)\n                  })\n                }\n                else {\n                  tsResult.columns = []\n                  var col1 = {}\n                  col1.text = 'Time'\n                  col1.type = 'time'\n                  col1.sort = true,\n                    col1.desc = true,\n                    tsResult.columns.push(col1)\n                  var col = {}\n                  col.text = 'v'\n                  col.type = 'number'\n                  tsResult.columns.push(col)\n                  col.text = 'sv'\n                  col.type = 'string'\n                  tsResult.columns.push(col)\n                  col.text = 'bv'\n                  col.type = 'boolean'\n                  tsResult.columns.push(col)\n                  tsResult.rows = []\n                  tsResult.type = 'table'\n                  args[i].data.v.forEach((value) => { // resource obj\n                    var row = []\n                    row.push(value.UnixTimestamp)\n                    row.push(value.v)\n                    row.push(value.sv)\n                    row.push(value.bv)\n                    tsResult.rows.push(row)\n                  })\n                }\n              }\n            }\n            else { // non table\n              tsResult.target = args[i].config.target\n              tsResult.datapoints = []\n  \n              if (args[i].data.AggregationType != null) {\n                //this is aggregation\n                args[i].data.v.forEach((value) => { // resource obj\n                  var arr = []\n                  arr.push(value.m)\n                  arr.push(value.t)\n                  tsResult.datapoints.push(arr)\n                })\n              }\n              else {\n                if (tsResult.target == 'ecgBlob') {                      \n                  args[i].data.v.forEach((value) => { // resource obj\n                    var arr = []\n                    var val = 0\n                    if (value.sv != null) {\n                      val = value.sv                      \n                        var data = val\n                        //const buffer = Buffer.from(data, 'base64');\n                        const timestamp = value.UnixTimestamp\n                        var unzipdata =''\n                        try{                          \n                          // Create Base64 Object\n                          //var Base64={_keyStr:\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\",encode:function(e){var t=\"\";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t=\"\";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9+/=]/g,\"\");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/rn/g,\"n\");var t=\"\";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t=\"\";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}                          \n                          var decodeddata = Base64.decode2(data)\n                          unzipdata = pako.inflate(decodeddata,{ to: 'string' })\n                          var varr = unzipdata.split(',')\n                          var firstts = timestamp - varr.length * 10 / 3 // fs = 300                            \n                          for (var i = 0; i < varr.length; i += 150) {\n                            var arr = []\n                            arr.push(varr[i]/1000)\n                            var ts = firstts + i * 10 / 3\n                            arr.push(ts)\n                            tsResult.datapoints.push(arr)\n                          }\n                          //console.log(unzipdata.toString());\n                        } catch (err){\n                          console.log(err);  \n                        }\n                    }\n                  })\n                  tsResult.datapoints = tsResult.datapoints.sort(function(a,b) { // sort according to ts\n                    return a[1] - b[1];\n                    });\n                }\n                else if (tsResult.target == 'latestmeasurement') {   \n                  latestMeasurementTime = args[i].data.LatestMeasurement.UnixTimestamp;\n                  if (args[i].data.LatestMeasurement.v != null) {\n                    latestMeasurementValue = args[i].data.LatestMeasurement.v\n                  }\n                  else if (args[i].data.LatestMeasurement.sv != null) {\n                    latestMeasurementValue = args[i].data.LatestMeasurement.sv\n                  }\n                  else {\n                    if(args[i].data.LatestMeasurement.bv) {\n                      latestMeasurementValue = 1 \n                    }\n                    else {\n                      latestMeasurementValue = 0\n                    }                    \n                  }\n\n                }\n                else {\n                  var voidLatestMeasurement  = false;\n                  args[i].data.v.forEach((value) => { // resource obj\n                    var arr = []\n                    var val = 0\n                    if (value.v != null) {\n                      val = value.v\n                    }\n                    else if (value.sv != null) {\n                      val = value.sv\n                    }\n                    else {\n                      if(value.bv) {\n                        val = 1 \n                      }\n                      else {\n                        val = 0\n                      }\n                      \n                    }\n                    arr.push(val)\n                    arr.push(value.UnixTimestamp)\n                    tsResult.datapoints.push(arr)\n                    if(latestMeasurementTime != null ) {\n                      if(value.UnixTimestamp == latestMeasurementTime) {\n                        voidLatestMeasurement = true;\n                      }\n                    }\n                  })\n                  if(latestMeasurementTime != null && voidLatestMeasurement!= true ) {\n                    var arr = []\n                    arr.push(latestMeasurementValue)\n                    arr.push(latestMeasurementTime)\n                    tsResult.datapoints.push(arr) // append latest measurement\n                  }\n                  \n                }\n              }\n            }            \n            if(tsResult.type == 'table'){\n              tsResultArray.push(tsResult)\n            }\n            else {\n              if(tsResult.datapoints.length>0){\n                tsResultArray.push(tsResult)\n              }\n            }\n          }\n          var result = {}\n          result.data = tsResultArray\n          resolve(result);\n  \n        }))\n        .catch((error) => {\n          console.log(error);\n          reject(error)\n        })\n      };\n    \n\n    /*return this.doRequest({\n      url: this.url + '/query',\n      data: query,\n      method: 'POST'\n    });*/\n    if (this.resourceList == null) {\n      return new Promise(function (resolve, reject) {\n        caller.getAllResourceUrlFromDevice(1)\n        .then((result) => {\n          caller.resourceList = result;        \n          console.log(caller.resourceList.length)\n          return getQueryForAppIoT(resolve, reject)        \n        })\n        .catch((err) => {\n          console.log(err)\n          reject(err)\n        })\n      })\n    }\n    else {\n      return new Promise(function (resolve, reject) {\n        getQueryForAppIoT(resolve, reject)\n            });\n    }\n    \n  }\n\n \n\n  testDatasource() {\n    const caller = this\n    return new Promise(function (resolve, reject) {\n      caller.getAllResourceUrlFromDevice(1)\n        .then((result) => {\n          caller.resourceList = result;\n          resolve({ status: \"success\", message: \"AppIoT data source is working. Connected with \" + caller.resourceList.length + \" resources.\", title: \"Success\" })\n        })\n        .catch((err) => {\n          console.log(err)\n          reject(err)\n        })\n    })\n\n\n    /*return this.doRequest({\n      url: this.url + '/',\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });*/\n  }\n\n  annotationQuery(options) {\n    const calleroption = options\n    const caller = this\n    return new Promise(function (resolve, reject) {\n      var eventcategoryname = calleroption.annotation.query //\"BLABHK_IoTServiceApp_Alert\" // need to put this to the configuration menu\n      let url = `${caller.appiot.apiURI}/events?filter[0].Key=EventCategoryName&filter[0].Value=${eventcategoryname}`\n      axios.get(url, { 'headers':caller.appiot.apiHeaders }) // todo get pagination\n        .then((result) => {\n          var arr = []\n          result.data.Rows.forEach((event)=>{\n            var time = new Date(event.CreatedDateTime).getTime()\n            var from = new Date(calleroption.range.from).getTime()\n            var to = new Date(calleroption.range.to).getTime()\n            if (time <= to && time >= from && event.EventCategoryName.toUpperCase() ==  calleroption.annotation.query.toUpperCase()) {\n              var ann = {}\n              ann.name = eventcategoryname\n              ann.enabled = true\n              ann.datasource = 'appiot datasource'\n              ann.showLine = true\n              var annotation = {}\n              annotation.annotation = calleroption.annotation\n              annotation.title = event.RuleName\n              annotation.time = time\n              annotation.text = 'created:' + event.CreatedDateTime + 'reset:' + event.ResetDateTime\n              annotation.tags = calleroption.annotation.query\n              arr.push(annotation)\n            }\n          })\n          resolve(arr)\n        })\n        .catch((err)=>{\n          console.log(err)\n          reject(err)\n        })\n      })\n          \n\n    /*var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n    return [];*/\n  }\n\n  metricFindQuery(query) {\n    /* var interpolated = {\n         target: this.templateSrv.replace(query, null, 'regex')\n     };\n \n     return this.doRequest({\n       url: this.url + '/search',\n       data: interpolated,\n       method: 'POST',\n     }).then(this.mapToTextValue);*/\n\n       // generate random geolocation data\n       \n    const caller = this\n    console.log('here metricFindQuery')\n    return new Promise(function (resolve, reject) {\n      caller.getAllResourceUrlFromDevice(1)\n        .then((result) => {\n          caller.resourceList = result;\n          var list = []\n          caller.resourceList.forEach((resource) => {\n            list.push(resource.Name)\n            if(resource.Name == 'BleSensor' || resource.Name == 'Heart Rate'){\n              list.push(resource.Name + \", 5min TimeWeightedAverage\")\n              list.push(resource.Name + \", 5min Variance\")\n            }            \n            //if(resource.Name == 'HealthSensor'){\n            //  list.push(resource.Name + \" Accuracy\")\n            //}\n          })\n          var result = {}\n          result.data = list\n          resolve(caller.mapToTextValue(result))\n        })\n        .catch((err) => {\n          console.log(err)\n          reject(err)\n        })\n\n    })\n\n  }\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return { text: d.text, value: d.value };\n      } else if (_.isObject(d)) {\n        return { text: d, value: i };\n      }\n      return { text: d, value: d };\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n\n"]}